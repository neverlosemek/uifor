--====================================================
-- CONTAINER INSPECTOR ESP (OPTIMIZED / NO LAG)
-- /e conesp = Only containers with IMPORTANT items
-- /e debug  = Show ALL containers + full inventory
--====================================================

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local Player = Players.LocalPlayer

-- New chat support
local TextChatService
pcall(function()
	TextChatService = game:GetService("TextChatService")
end)

----------------------------------------------------
-- SETTINGS
----------------------------------------------------

local IMPORTANT_ITEMS = {
	FlareGun = true,
	AsVal = true,
	AI4 = true
}

local BASE_TEXT_SIZE = 12
local MAX_DISTANCE = 1200

-- Performance tuning
local SCAN_INTERVAL = 0.75 -- seconds between inventory scans
local BOUNDS_UPDATE_INTERVAL = 0.15 -- seconds between bounding box recalcs

----------------------------------------------------
-- STATE
----------------------------------------------------

local conESPEnabled = false
local debugEnabled = false

-- key = model, value = { billboard, attach, part, lastText, lastBoundsTime }
local espMap = {}

local lastScanTime = 0

----------------------------------------------------
-- UTILITY
----------------------------------------------------

local function getAnyPart(model)
	if model.PrimaryPart and model.PrimaryPart:IsA("BasePart") then
		return model.PrimaryPart
	end
	for _,d in ipairs(model:GetDescendants()) do
		if d:IsA("BasePart") then
			return d
		end
	end
	return nil
end

local function clearESP()
	for _,obj in pairs(espMap) do
		if obj.billboard and obj.billboard.Parent then
			obj.billboard:Destroy()
		end
		if obj.attach and obj.attach.Parent then
			obj.attach:Destroy()
		end
	end
	table.clear(espMap)
end

----------------------------------------------------
-- BILLBOARD CREATION
----------------------------------------------------

local function createOrUpdateTag(model, part, text, hasImportant)
	local obj = espMap[model]

	if not obj then
		local attach = Instance.new("Attachment")
		attach.Name = "ESPAnchor"
		attach.Parent = part

		local billboard = Instance.new("BillboardGui")
		billboard.Name = "ContainerESP"
		billboard.Size = UDim2.new(0, 180, 0, 18 + (#string.split(text, "\n") * 14))
		billboard.StudsOffset = Vector3.zero
		billboard.AlwaysOnTop = true
		billboard.MaxDistance = MAX_DISTANCE
		billboard.Adornee = attach

		local label = Instance.new("TextLabel")
		label.Name = "Label"
		label.Size = UDim2.new(1, 0, 1, 0)
		label.BackgroundTransparency = 1
		label.TextWrapped = true
		label.TextXAlignment = Enum.TextXAlignment.Left
		label.TextYAlignment = Enum.TextYAlignment.Top
		label.TextStrokeTransparency = 0.25
		label.Font = Enum.Font.GothamBold
		label.TextSize = BASE_TEXT_SIZE
		label.Parent = billboard

		billboard.Parent = part

		obj = {
			billboard = billboard,
			label = label,
			attach = attach,
			part = part,
			lastText = "",
			lastBoundsTime = 0
		}

		espMap[model] = obj
	end

	-- Only update visuals if text changed
	if obj.lastText ~= text then
		obj.label.Text = text
		obj.label.TextColor3 = hasImportant
			and Color3.fromRGB(255, 120, 120)
			or Color3.fromRGB(220, 220, 220)

		obj.billboard.Size = UDim2.new(
			0, 180,
			0, 18 + (#string.split(text, "\n") * 14)
		)

		obj.lastText = text
	end
end

----------------------------------------------------
-- INVENTORY READER
----------------------------------------------------

local function readInventory(inv)
	local results = {}

	for name, _ in pairs(inv:GetAttributes()) do
		table.insert(results, name)
	end

	for _,child in ipairs(inv:GetChildren()) do
		table.insert(results, child.Name)
	end

	return results
end

----------------------------------------------------
-- RECURSIVE FIND
----------------------------------------------------

local function collectInventoryModels(root, out)
	for _,child in ipairs(root:GetChildren()) do
		if child:IsA("Model") then
			if child:FindFirstChild("Inventory") then
				table.insert(out, child)
			end
			collectInventoryModels(child, out)
		elseif child:IsA("Folder") then
			collectInventoryModels(child, out)
		end
	end
end

----------------------------------------------------
-- CORE SCAN (SLOW LOOP)
----------------------------------------------------

local function scanContainers(showAll)
	local containersFolder = Workspace:FindFirstChild("Containers")
	if not containersFolder then return end

	local foundModels = {}
	collectInventoryModels(containersFolder, foundModels)

	local alive = {}

	for _,container in ipairs(foundModels) do
		local inv = container:FindFirstChild("Inventory")
		local part = getAnyPart(container)
		if not (inv and part) then continue end

		local items = readInventory(inv)

		local importantList = {}
		local normalList = {}

		for _,name in ipairs(items) do
			if IMPORTANT_ITEMS[name] then
				table.insert(importantList, name)
			else
				table.insert(normalList, name)
			end
		end

		if not showAll and #importantList == 0 then
			-- remove ESP if it exists
			if espMap[container] then
				if espMap[container].billboard then
					espMap[container].billboard:Destroy()
				end
				if espMap[container].attach then
					espMap[container].attach:Destroy()
				end
				espMap[container] = nil
			end
			continue
		end

		local lines = {}
		table.insert(lines, "ðŸ“¦ " .. container.Name)

		for _,name in ipairs(importantList) do
			table.insert(lines, "â­ " .. name)
		end

		if showAll then
			for _,name in ipairs(normalList) do
				table.insert(lines, "â€¢ " .. name)
			end
			if #items == 0 then
				table.insert(lines, "â€¢ (Empty)")
			end
		end

		local text = table.concat(lines, "\n")

		createOrUpdateTag(container, part, text, #importantList > 0)
		alive[container] = true
	end

	-- Cleanup ESPs for containers that no longer exist
	for model,obj in pairs(espMap) do
		if not alive[model] then
			if obj.billboard then obj.billboard:Destroy() end
			if obj.attach then obj.attach:Destroy() end
			espMap[model] = nil
		end
	end
end

----------------------------------------------------
-- WORLD-SPACE UPDATE LOOP (FAST)
----------------------------------------------------

RunService.RenderStepped:Connect(function()
	local now = os.clock()
	for model,obj in pairs(espMap) do
		if model.Parent and obj.attach and obj.part then
			if now - obj.lastBoundsTime >= BOUNDS_UPDATE_INTERVAL then
				local cf, size = model:GetBoundingBox()
				obj.attach.WorldPosition =
					cf.Position + Vector3.new(0, size.Y / 2 + 0.6, 0)
				obj.lastBoundsTime = now
			end
		end
	end
end)

----------------------------------------------------
-- COMMAND HANDLER
----------------------------------------------------

local function handleCommand(raw)
	if not raw then return end
	local msg = string.lower(raw)

	if msg == "/e conesp" or msg == "conesp" then
		debugEnabled = false
		conESPEnabled = not conESPEnabled

		if conESPEnabled then
			print("[CONESP] Enabled")
		else
			print("[CONESP] Disabled")
			clearESP()
		end
	end

	if msg == "/e debug" or msg == "debug" then
		conESPEnabled = false
		debugEnabled = not debugEnabled

		if debugEnabled then
			print("[DEBUG ESP] Enabled")
		else
			print("[DEBUG ESP] Disabled")
			clearESP()
		end
	end
end

Player.Chatted:Connect(handleCommand)

if TextChatService and TextChatService.MessageReceived then
	TextChatService.MessageReceived:Connect(function(msg)
		if msg.TextSource and msg.TextSource.UserId == Player.UserId then
			handleCommand(msg.Text)
		end
	end)
end

----------------------------------------------------
-- SLOW SCAN LOOP
----------------------------------------------------

RunService.Heartbeat:Connect(function()
	local now = os.clock()
	if now - lastScanTime < SCAN_INTERVAL then return end
	lastScanTime = now

	if debugEnabled then
		scanContainers(true)
	elseif conESPEnabled then
		scanContainers(false)
	end
end)

print("[CONTAINER ESP] Loaded | /e conesp | /e debug")
